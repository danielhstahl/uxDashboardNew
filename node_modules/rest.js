var request = require('request');
var yieldData={};
module.exports=function getYieldData(callback){
    var api_key='6b75e4bc06a6ed991a7a9cc64d70c3fa';
    var series=[
      {
        name:'USD1WKD156N',
        days:7,
        type:"LIBOR",
        value:''
      },//one week libor
      {
        name:'USD1MTD156N',
        days:30,
        type:"LIBOR",
        value:''
      },//thirty week libor
      {
        name:'USD3MTD156N',
        days:90,
        type:"LIBOR",
        value:''
      },
      {name:'USD6MTD156N',
        days:180,
        type:"LIBOR",
        value:''
      },
      {
        name:'USD12MD156N',
        days:360,
        type:"LIBOR",
        value:''
      },
      {name:'DSWP1',
        days:360,
        type:"Swap",
        value:''
      },
      {name:'DSWP2',
        days:720,
        type:"Swap",
        value:''
      },
      {name:'DSWP3',
        days:1080,
        type:"Swap",
        value:''
      },
      {name:'DSWP4',
        days:1440,
        type:"Swap",
        value:''
      },
      {name:'DSWP5',
        days:1800,
        type:"Swap",
        value:''
      },
      {name:'DSWP7',
        days:2520,
        type:"Swap",
        value:''
      },
      {name:'DSWP10',
        days:3600,
        type:"Swap",
        value:''
      },
      {name:'DSWP30',
        days:10800,
        type:"Swap",
        value:''
      }
    ];
    timeSeries={};
    //var keys=Object.keys(series);
    var n=series.length;//+1;
    var totalCount=0;
    var myGetRequest=function(i){
      request({
          url:"https://api.stlouisfed.org/fred/series/observations",
          qs:{
            api_key: api_key,
            series_id: series[i].name,
            file_type: 'json',
            sort_order:'desc',
            limit:1
          }
        },
        function (error, response, result) {
          totalCount++;
          //console.log(error);

          result=JSON.parse(result);
        //  console.log(result);
          series[i].value=result.observations[0].value;
          if(totalCount===n){
            yieldData.yield=series;
          }
          if(totalCount===(n+1)){
            callback(yieldData);
            //console.log(yieldData);
            /*child.stdin.write(
              JSON.stringify(yieldData)
            );
            child.stdin.write("\n");*/
            /*CPPData.upsert(
              {
                select:"yield"
              },
              {
                $set:
                  {
                    select:"yield",
                    yield:series
                  }
                }
            );*/
          }
        }
      );
    }
    for(var i=0; i<n; i++){
      myGetRequest(i);
    }
    request({

    url:"https://api.stlouisfed.org/fred/series/observations",
      qs:
        {
          api_key: api_key,
          series_id: series[0].name,
          file_type: 'json'
        }
      },
      function (error, response, result) {
        totalCount++;
        result=JSON.parse(result);
        yieldData.series={history:result.observations, days:7};//});
        if(totalCount===(n+1)){
          callback(yieldData);
          //console.log(yieldData);
        /*  child.stdin.write(
            JSON.stringify(yieldData)
          );
          child.stdin.write("\n");*/

        }
      }
    );
  }
//});
